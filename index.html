<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bug hunt</title>
</head>
<body>
    <h6>https://github.com/subins2000/p2pt</h6>
    <p>try: p2pt.send(peers[0], 'odoooo')</p>
    <!--<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/subins2000/p2pt/dist/p2pt.umd.js"></script>-->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/subins2000/p2pt/dist/p2pt.umd.js"></script>
    <div id="log"></div>
    <script>
let logger = document.getElementById('log');
log = msg => {
  if (typeof msg == 'object') {
    logger.innerHTML += (JSON && JSON.stringify ? JSON.stringify(msg, undefined, 2) : msg) + '<br />';
  } else {
    logger.innerHTML += msg + '<br />';
  }
}

// Find public WebTorrent tracker URLs here : https://github.com/ngosang/trackerslist/blob/master/trackers_all_ws.txt
var trackersAnnounceURLs = [
  "wss://tracker.openwebtorrent.com",
  "wss://tracker.sloppyta.co:443/announce",
  "wss://tracker.novage.com.ua:443/announce",
  "wss://tracker.btorrent.xyz:443/announce",
]

// This 'myApp' is called identifier and should be unique to your app
var p2pt = new P2PT(trackersAnnounceURLs, 'ruediRaschle3567147')

// If a tracker connection was successful
p2pt.on('trackerconnect', (tracker, stats) => {
  log('Connected to tracker : ' + tracker.announceUrl)
  log('Tracker stats : ' + JSON.stringify(stats))
  log('')
})

self.peers = []
// If a new peer, send message
p2pt.on('peerconnect', (peer) => {
  /************************************************************************************/
  self.peers.push(peer)
  peer.sst_element = document.createElement('span')
  peer.sst_element.style.position = 'absolute'
  peer.sst_element.style.backgroundColor = getColorCode()
  peer.sst_element.style.width = '10px'
  peer.sst_element.style.height = '10px'
  document.body.appendChild(peer.sst_element)
  /************************************************************************************/
  log('New Peer ! : ' + peer.id + '. Sending Hi')
  this.p2pt.send(peer, 'Hi').then(([peer, msg]) => {
    log('Got response : ' + msg)
    return peer.respond('Bye')
  }).then(([peer, msg]) => {
    log('Got response2 : ' + msg)
  })
})

// If message received from peer
p2pt.on('msg', (peer, msg) => {
  /*log(`Got message from ${peer.id} : ${msg}`)
  if (msg === 'Hi') {
    peer.respond('Hello !').then(([peer, msg]) => {
      peer.respond('Bye !')
    })
  }*/
  try {
    const msgObject = JSON.parse(msg)
    console.log('msg', msgObject);
    peer.sst_element.style.left = msgObject.x + 'px'
    peer.sst_element.style.top = msgObject.y + 'px'
  } catch (error) {
    
  }
})

log('P2PT started. My peer id : ' + p2pt._peerId)
p2pt.start()

/* *************************************************************************************** */
const cursor = document.createElement('span')
cursor.style.position = 'absolute'
cursor.style.backgroundColor = getColorCode()
cursor.style.width = '10px'
cursor.style.height = '10px'
document.body.appendChild(cursor)
self.addEventListener('mousemove', event => {
  if (!event.offsetX) return
  if (!event.offsetY) return
  self.peers.forEach(peer => this.p2pt.send(peer, JSON.stringify({x: event.offsetX, y: event.offsetY})))
  cursor.style.left = event.offsetX + 'px'
  cursor.style.top = event.offsetY + 'px'
})
console.log('changed', this.p2pt);
self.addEventListener('beforeunload', event => p2pt.destroy())

// https://www.tutorialspoint.com/random-color-generator-in-javascript
function getColorCode() {
      var makeColorCode = '0123456789ABCDEF';
      var code = '#';
      for (var count = 0; count < 6; count++) {
         code =code+ makeColorCode[Math.floor(Math.random() * 16)];
      }
      return code;
   }
    </script>
</body>
</html>
